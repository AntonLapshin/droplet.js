!function(e,t){"function"==typeof define&&define.amd?define(["jquery"],t):"object"==typeof module&&module.exports?module.exports=t(require("jquery")):e.Droplet=t(e.$)}(this,function(e){function t(e,t){return"{0}{1}".f(e?e+"+":"",t)}function n(n){var i,o,s=e.Deferred(),a=n.attr("data-droplet"),u=v[a],d=n.parents("[data-droplet]").eq(0),h=d.attr("data-name"),l=n.attr("data-call"),f=t(h,a);h&&(i=c[h],"byIndex"===l?(i.children[a]||(i.children[a]=[]),o=i.children[a].length,f+="[{0}]".f(o)):""!==l&&(i.children[a]||(i.children[a]={}),f+="[{0}]".f(l))),n.addClass(a).attr("data-ready",!0).attr("data-name",f).hide().html(u.view);var p=new b(a,f,u.constructor,n);if(c[f]=p,h){var i=c[h];void 0!==o?i.children[a].push(p):l?i.children[a][l]=p:i.children[a]=p,p.parent=i}return r(n).then(function(){p.load(),s.resolve(p)}),s}function r(t){t=t||e("body");var r=t.find("[data-droplet]").not("[data-ready]");if(0===r.length){var i=e.Deferred();return i.resolve(),i}var o=[];return r.each(function(){var t=e(this);o.push(n(t))}),e.when.apply(this,o)}function i(t,n,i){e(t);return l(n).then(function(){var n=e(t);return n.append(i),r(n)})}function o(t,n){if(!n||0===n.length){var r=e.Deferred();return r.resolve(),r}var i=D.baseUrl.f(t),o=[];return e.each(n,function(e,t){var n=i+t;n.endsWith(".jpg")||n.endsWith("png")?o.push(s(n)):n.endsWith(".html")?o.push(a(n)):n.endsWith(".css")?o.push(u(n)):n.endsWith(".js")?o.push(h(n)):o.push(l(n.split("/").pop()))}),e.when.apply(this,o)}function s(t){var n=e.Deferred();if(m[t])return n.resolve(m[t]),n;var r=e("<img />").on("load",function(){m[t]=r,n.resolve(r)}).attr("src",t);return setTimeout(function(){m[t]=!0,n.resolve(r)},D.timeout),n}function a(t){var n=e.Deferred();return y[t]||window.production?void n.resolve(y[t]):(e("<div />").load(t,function(e,r,i){if("success"!==r)throw"Cannot load the view: {0}".f(t);y[t]=e,n.resolve(e)}),n)}function u(t){var n=e.Deferred();return w[t]||window.production?(n.resolve(w[t]),n):(e('<link rel="stylesheet" type="text/css" href="{0}" />'.f(t)).appendTo("head"),w[t]=!0,n.resolve(),n)}function d(t){var n=e.Deferred(),r=document.createElement("script");return r.type="text/javascript",r.readyState?r.onreadystatechange=function(){"loaded"!=r.readyState&&"complete"!=r.readyState||(r.onreadystatechange=null,n.resolve())}:r.onload=function(){n.resolve()},r.src=t,document.getElementsByTagName("head")[0].appendChild(r),n}function h(t){var n=e.Deferred();return g[t]?(n.resolve(g[t]),n):(window.require?require([t.substr(0,t.length-3)],function(e){g[t]=e,n.resolve(e)}):d(t).then(function(){g[t]=!0,n.resolve()}),n)}function l(t){if(v[t]){var n=e.Deferred();return n.resolve(v[t]),n}var r={name:t,deps:null};v[t]=r;var i=e.Deferred();Droplet.on("{0}.load".f(t),function(e){i.resolve(e)});var s=e.Deferred();return o(t,["view.html","style.css","logic.js"]).then(function(e){r.view=e,s.resolve()}),e.when.apply(this,[i,s])}String.prototype.f=function(){var e=arguments;return this.replace(/{(\d+)}/g,function(t,n){return"undefined"!=typeof e[n]?e[n]:t})};var c={},f=[],p={},v={},y={},w={},m={},g={},D={baseUrl:"./droplets/{0}/",timeout:2e3},b=function(){function t(){this.events={}}function n(e,t,n,r){this.dropletName=e,this.name=t,this.$all=r.find("*").not("[data-droplet]"),this.$droplet=r,this.children={},n(this)}function r(r,i,o,s){t.call(this),n.call(this,r,i,o,s);var a=this;return e.each(f,function(e,t){t.call(a)}),this}return t.prototype={on:function(e,t){this.events.hasOwnProperty(e)||(this.events[e]=[]),this.events[e].push(t)},fire:function(t,n){this.events.hasOwnProperty(t)&&e.each(this.events[t],function(e,t){t(n)})}},n.prototype={set:function(e){return this.fire("set",e),this.data=e,this},load:function(){return this.fire("load"),this},show:function(){return this.$droplet.show(),this.fire("show"),this},hide:function(){return this.$droplet.hide(),this.fire("hide"),this},test:function(){return this.$droplet.hide(),this.fire("test"),this}},r.prototype=e.extend({},t.prototype,n.prototype),r.prototype.constructor=r,r}();return{Instance:b,define:function(){var e=arguments[0],t=arguments[1],n=arguments[2],r=v[e];return o(e,t).then(function(){r.deps=arguments,r.constructor=function(e){n.apply(e,r.deps)},Droplet.fire("{0}.load".f(e),r)}),this},append:function(e,t){return i(t,e,'<div data-droplet="{0}"></div>'.f(e))},appendList:function(t,n,r,o,s){for(var a="",u='<li data-droplet="{0}" data-call="byIndex"></li>'.f(r),d=0;d<o.length;d++)a+=u;return i(n,r,a).then(function(){e.each(o,function(e,n){t.children[r][e].set(n),!s&&t.children[r][e].show()})})},run:function(e){var t=window.location.search,n=t.length>0?t.substring(1):null;return this.append(n,e).then(function(e){e.test()})},loadDroplet:l,loadImage:s,on:function(e,t){return p.hasOwnProperty(e)||(p[e]=[]),p[e].push(t),this},off:function(e,t){if(!p.hasOwnProperty(e))return this;var n=p[e].indexOf(t);return p[e].splice(n,1),this},fire:function(t,n){return p.hasOwnProperty(t)?(e.each(p[t],function(e,t){t(n)}),this):this},addExtension:function(e){return f.push(e),this},setOptions:function(t){return t.baseUrl&&(t.baseUrl=t.baseUrl+"/{0}/"),D=e.extend(D,t),this}}});