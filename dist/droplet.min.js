!function(e,t){"function"==typeof define&&define.amd?define(["jquery"],t):"object"==typeof module&&module.exports?module.exports=t(require("jquery")):e.Droplet=t(e.$)}(this,function(e){function t(e,t){return"{0}{1}".f(e?e+"+":"",t)}function n(n){var o,i,s=e.Deferred(),a=n[0].nodeName.toLowerCase(),d=y[a],u=n.closest("[data-ready]"),h=u.attr("data-name"),f=n.attr("data-droplet"),c=t(h,a);h&&(o=l[h],"li"===f?(o.children[a]||(o.children[a]=[]),i=o.children[a].length,c+="[{0}]".f(i)):""!==f&&(o.children[a]||(o.children[a]={}),c+="[{0}]".f(f))),n.attr("data-name",c).attr("data-ready",!0).hide().html(d.view);var p=new j(a,c,d.constructor,n);if(l[c]=p,h){var o=l[h];void 0!==i?o.children[a].push(p):f?o.children[a][f]=p:o.children[a]=p,p.parent=o;var v=o["{0}Loaded".f(a)];v&&v(p)}return r(n).then(function(){p.load(),s.resolve()}),s}function r(t,r){var o=e.Deferred();t=t||e("body");var i=t.find("{0}[data-droplet]".f(r||"")),s=[];return i.each(function(){var t=e(this);s.push(n(t))}),0===i.length?(o.resolve(),o):(e.when.apply(this,s).then(function(){o.resolve()}),o)}function o(e,t){for(var n="",r='<{0} data-droplet="li"></{0}>'.f(e),o=0;t>o;o++)n+=r;return n}function i(t,n){var o=e.Deferred();return t.append("<{0} data-droplet></{0}>".f(n)),r(t,n).then(function(){var e=t.find("> {0}[data-ready]".f(n)).attr("data-name"),r=l[e];o.resolve(r)}),o}function s(t,n){var r=b.baseUrl.f(t),o=[];return e.each(n,function(e,t){var n=r+t;n.endsWith(".jpg")||n.endsWith("png")?o.push(a(n)):n.endsWith(".html")?o.push(d(n)):n.endsWith(".css")?o.push(u(n)):n.endsWith(".js")?o.push(f(n)):o.push(c(n.split("/").pop()))}),e.when.apply(this,o)}function a(t){var n=e.Deferred();if(g[t])return n.resolve(g[t]),n;var r=e("<img />").on("load",function(){g[t]=r,n.resolve(r)}).attr("src",t);return setTimeout(function(){g[t]=!0,n.resolve(r)},b.timeout),n}function d(t){var n=e.Deferred();return m[t]||window.production?void n.resolve(m[t]):(e("<div />").load(t,function(e,r,o){if("success"!==r)throw"Cannot load the view: {0}".f(t);m[t]=e,n.resolve(e)}),n)}function u(t){var n=e.Deferred();return w[t]||window.production?(n.resolve(w[t]),n):(e('<link rel="stylesheet" type="text/css" href="{0}" />'.f(t)).appendTo("head"),w[t]=!0,n.resolve(),n)}function h(t){var n=e.Deferred(),r=document.createElement("script");return r.type="text/javascript",r.readyState?r.onreadystatechange=function(){"loaded"!=r.readyState&&"complete"!=r.readyState||(r.onreadystatechange=null,n.resolve())}:r.onload=function(){n.resolve()},r.src=t,document.getElementsByTagName("head")[0].appendChild(r),n}function f(t){var n=e.Deferred();if(t=t.substr(0,t.length-3),D[t])return n.resolve(D[t]),n;if(!require)throw"Loading js dependecies is not implemented";return require([t],function(e){D[t]=e,n.resolve(e)}),n}function c(t){var n=e.Deferred();if(y[t])return n.resolve(y[t]),n;var r=b.baseUrl.f(t)+"logic.js";return Droplet.on("{0}.onload".f(t),function(e){n.resolve(e)}),h(r).then(function(){D[r]=!0}),n}String.prototype.f=function(){var e=arguments;return this.replace(/{(\d+)}/g,function(t,n){return"undefined"!=typeof e[n]?e[n]:t})};var l={},p=[],v={},y={},m={},w={},g={},D={},b={baseUrl:"./droplets/{0}/",timeout:2e3},j=function(){function t(){this.events={}}function n(e,t,n,r){this.dropletName=e,this.name=t,this.$droplet=r,this.$all=r.find("*").not("[data-droplet]"),this.$view=r.children().first(),this.children={},n(this)}function r(r,o,i,s){t.call(this),n.call(this,r,o,i,s);var a=this;return e.each(p,function(e,t){t.call(a)}),this}return t.prototype={on:function(e,t){this.events.hasOwnProperty(e)||(this.events[e]=[]),this.events[e].push(t)},fire:function(t,n){this.events.hasOwnProperty(t)&&e.each(this.events[t],function(e,t){t(n)})}},n.prototype={set:function(e){return this.fire("set",e),this.data=e,this},load:function(){return this.fire("load"),this},show:function(){return this.$droplet.show(),this.fire("show"),this},hide:function(){return this.$droplet.hide(),this.fire("hide"),this},test:function(){return this.$droplet.hide(),this.fire("test"),this}},r.prototype=e.extend({},t.prototype,n.prototype),r.prototype.constructor=r,r}();return{Instance:j,define:function(){var e,t,n,r;n=n||[],t=arguments[0],n=arguments[1],r=arguments[2],n.push("view.html"),n.push("style.css"),y[t]||s(t,n).then(function(){var n={deps:arguments,view:e||arguments[arguments.length-2],name:t};y[t]=n,n.constructor=function(e){r.apply(e,n.deps)},Droplet.fire("{0}.onload".f(t),n)})},append:function(t,n){var r=e.Deferred(),o=e(n);return y[t]?(i(o,t).then(r.resolve),r):(c(t).then(function(){i(o,t).then(r.resolve)}),r)},buildList:function(t,n,i,s,a){var d=e.Deferred(),u=o(i,s.length);return n.html(u),r(n).then(function(){e.each(s,function(e,n){t.children[i][e].set(n),a||t.children[i][e].show()}),d.resolve()}),d},loadDroplet:c,loadImage:a,on:function(e,t){v.hasOwnProperty(e)||(v[e]=[]),v[e].push(t)},fire:function(t,n){v.hasOwnProperty(t)&&e.each(v[t],function(e,t){t(n)})},addExtension:function(e){p.push(e)},setOptions:function(t){t.baseUrl&&(t.baseUrl=t.baseUrl+"/{0}/"),b=e.extend(b,t)}}});