!function(e,t){"function"==typeof define&&define.amd?define(["jquery"],t):"object"==typeof module&&module.exports?module.exports=t(require("jquery")):e.Droplet=t(e.$)}(this,function(e){function t(e,t){return"{0}{1}".f(e?e+"+":"",t)}function n(n){var o,i,a=e.Deferred(),s=n.attr("data-droplet"),d=v[s],u=n.parents("[data-droplet]").eq(0),h=u.attr("data-name"),l=n.attr("data-call"),f=t(h,s);h&&(o=c[h],"byIndex"===l?(o.children[s]||(o.children[s]=[]),i=o.children[s].length,f+="[{0}]".f(i)):""!==l&&(o.children[s]||(o.children[s]={}),f+="[{0}]".f(l))),n.addClass(s).attr("data-ready",!0).attr("data-name",f).hide().html(d.view);var p=new b(s,f,d.constructor,n);if(c[f]=p,h){var o=c[h];void 0!==i?o.children[s].push(p):l?o.children[s][l]=p:o.children[s]=p,p.parent=o}return r(n).then(function(){p.load(),a.resolve(p)}),a}function r(t){t=t||e("body");var r=t.find("[data-droplet]").not("[data-ready]");if(0===r.length){var o=e.Deferred();return o.resolve(),o}var i=[];return r.each(function(){var t=e(this);i.push(n(t))}),e.when.apply(this,i)}function o(t,n,o){e(t);return l(n).then(function(){var n=e(t);return n.append(o),r(n)})}function i(t,n){if(!n||0===n.length){var r=e.Deferred();return r.resolve(),r}var o=D.baseUrl.f(t),i=[];return e.each(n,function(e,t){var n=o+t;n.endsWith(".jpg")||n.endsWith("png")?i.push(a(n)):n.endsWith(".html")?i.push(s(n)):n.endsWith(".css")?i.push(d(n)):n.endsWith(".js")?i.push(h(n)):i.push(l(n.split("/").pop()))}),e.when.apply(this,i)}function a(t){var n=e.Deferred();if(m[t])return n.resolve(m[t]),n;var r=e("<img />").on("load",function(){m[t]=r,n.resolve(r)}).attr("src",t);return setTimeout(function(){m[t]=!0,n.resolve(r)},D.timeout),n}function s(t){var n=e.Deferred();return y[t]||window.production?void n.resolve(y[t]):(e("<div />").load(t,function(e,r,o){if("success"!==r)throw"Cannot load the view: {0}".f(t);y[t]=e,n.resolve(e)}),n)}function d(t){var n=e.Deferred();return w[t]||window.production?(n.resolve(w[t]),n):(e('<link rel="stylesheet" type="text/css" href="{0}" />'.f(t)).appendTo("head"),w[t]=!0,n.resolve(),n)}function u(t){var n=e.Deferred(),r=document.createElement("script");return r.type="text/javascript",r.readyState?r.onreadystatechange=function(){"loaded"!=r.readyState&&"complete"!=r.readyState||(r.onreadystatechange=null,n.resolve())}:r.onload=function(){n.resolve()},r.src=t,document.getElementsByTagName("head")[0].appendChild(r),n}function h(t){var n=e.Deferred();return g[t]?(n.resolve(g[t]),n):(window.require?require([t.substr(0,t.length-3)],function(e){g[t]=e,n.resolve(e)}):u(t).then(function(){g[t]=!0,n.resolve()}),n)}function l(t){if(v[t]){var n=e.Deferred();return n.resolve(v[t]),n}var r={name:t,deps:null};v[t]=r;var o=e.Deferred();Droplet.on("{0}.load".f(t),function(e){o.resolve(e)});var a=e.Deferred();return i(t,["view.html","style.css","logic.js"]).then(function(e){r.view=e,a.resolve()}),e.when.apply(this,[o,a])}String.prototype.f=function(){var e=arguments;return this.replace(/{(\d+)}/g,function(t,n){return"undefined"!=typeof e[n]?e[n]:t})};var c={},f=[],p={},v={},y={},w={},m={},g={},D={baseUrl:"./droplets/{0}/",timeout:2e3},b=function(){function t(){this.events={}}function n(e,t,n,r){this.dropletName=e,this.name=t,this.$all=r.find("*").not("[data-droplet]"),this.$droplet=r,this.children={},n(this)}function r(r,o,i,a){t.call(this),n.call(this,r,o,i,a);var s=this;return e.each(f,function(e,t){t.call(s)}),this}return t.prototype={on:function(e,t){this.events.hasOwnProperty(e)||(this.events[e]=[]),this.events[e].push(t)},fire:function(t,n){this.events.hasOwnProperty(t)&&e.each(this.events[t],function(e,t){t(n)})}},n.prototype={set:function(e){return this.fire("set",e),this.data=e,this},load:function(){return this.fire("load"),this},show:function(){return this.$droplet.show(),this.fire("show"),this},hide:function(){return this.$droplet.hide(),this.fire("hide"),this},test:function(){return this.$droplet.hide(),this.fire("test"),this}},r.prototype=e.extend({},t.prototype,n.prototype),r.prototype.constructor=r,r}();return{Instance:b,define:function(){var e=arguments[0],t=arguments[1],n=arguments[2],r=v[e];i(e,t).then(function(){r.deps=arguments,r.constructor=function(e){n.apply(e,r.deps)},Droplet.fire("{0}.load".f(e),r)})},append:function(e,t){return o(t,e,'<div data-droplet="{0}"></div>'.f(e))},appendList:function(t,n,r,i,a){for(var s="",d='<li data-droplet="{0}" data-call="byIndex"></li>'.f(r),u=0;u<i.length;u++)s+=d;return o(n,r,s).then(function(){e.each(i,function(e,n){t.children[r][e].set(n),!a&&t.children[r][e].show()})})},run:function(e){var t=window.location.search,n=t.length>0?t.substring(1):null;this.append(n,e).then(function(e){e.test()})},loadDroplet:l,loadImage:a,on:function(e,t){p.hasOwnProperty(e)||(p[e]=[]),p[e].push(t)},off:function(e,t){if(p.hasOwnProperty(e)){var n=p[e].indexOf(t);p[e].splice(n,1)}},fire:function(t,n){p.hasOwnProperty(t)&&e.each(p[t],function(e,t){t(n)})},addExtension:function(e){f.push(e)},setOptions:function(t){t.baseUrl&&(t.baseUrl=t.baseUrl+"/{0}/"),D=e.extend(D,t)}}});