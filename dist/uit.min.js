"use strict";function define(t,e,n){var o={name:t,deps:null};blocks[t]=o,o.promise=new Promise(function(r){loadDeps(t,["view.html","style.css"].concat(toConsumableArray(e))).then(function(e){for(var i=arguments.length,a=Array(i>1?i-1:0),l=1;l<i;l++)a[l-1]=arguments[l];o.view=e,o.deps=a,o.logic=function(t){n.apply(t,o.deps)},event.fire(t+".load",o),r(o)})})}function append(t,e){return mount(e,t,"<div "+opts.DATA_BLOCK_NAME_ATTRIBUTE+'="'+t+'"></div>')}function run(t){var e=window.location.search,n=e.length>0?e.substring(1):null;return this.append(n,t).then(function(t){t.test()})}Object.defineProperty(exports,"__esModule",{value:!0});var classCallCheck=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},createClass=function(){function t(t,e){for(var n=0;n<e.length;n++){var o=e[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}return function(e,n,o){return n&&t(e.prototype,n),o&&t(e,o),e}}(),get=function t(e,n,o){null===e&&(e=Function.prototype);var r=Object.getOwnPropertyDescriptor(e,n);if(void 0===r){var i=Object.getPrototypeOf(e);return null===i?void 0:t(i,n,o)}if("value"in r)return r.value;var a=r.get;if(void 0!==a)return a.call(o)},inherits=function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)},possibleConstructorReturn=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e},toConsumableArray=function(t){if(Array.isArray(t)){for(var e=0,n=Array(t.length);e<t.length;e++)n[e]=t[e];return n}return Array.from(t)},_uid=0,PubSub=function(){function t(){classCallCheck(this,t),this.handlers={}}return createClass(t,[{key:"on",value:function(t,e){this.handlers.hasOwnProperty(t)||(this.handlers[t]=[]);var n=_uid++;return this.handlers[t].push({token:n,handler:e}),n}},{key:"fire",value:function(t,e,n){return!!this.handlers.hasOwnProperty(t)&&(this.handlers[t].forEach(function(t){return t.handler(e,n)}),!0)}},{key:"off",value:function(t){var e=this;for(var n in this.handlers)!function(n){var o=e.handlers[n];o.forEach(function(e,n){if(e.token===t)return o.splice(n,1),!0})}(n);return!1}},{key:"once",value:function(t,e){var n=this,o=this.on(t,function(t){e(t),n.off(o)})}}]),t}(),combinePath=function(t,e){return(t?t+"+":"")+e},matches=function(t,e){return(t.matches||t.matchesSelector||t.msMatchesSelector||t.mozMatchesSelector||t.webkitMatchesSelector||t.oMatchesSelector).call(t,e)},findAncestor=function(t,e){for(;(t=t.parentElement)&&!matches(t,e););return t},blocks={},_instances={},build=function(t){return new Promise(function(e){var n=t.getAttribute(opts.DATA_BLOCK_NAME_ATTRIBUTE),o=blocks[n];if(!o.view)throw"View of "+n+" droplet is undefined";var r=findAncestor(t,"["+opts.DATA_BLOCK_NAME_ATTRIBUTE+"]"),i=r?r.getAttribute(opts.DATA_BLOCK_PATH_ATTRIBUTE):"root",a=t.getAttribute(opts.DATA_BLOCK_CALL_ATTRIBUTE),l=combinePath(i,n);if(r){var s=_instances[i];a===opts.CALL_BY_INDEX?(s.children[n]||(s.children[n]=[]),l+="["+s.children[n].length+"]"):"string"==typeof a&&(s.children[n]||(s.children[n]={}),l+="["+a+"]")}t.classList.add(n),t.addAttribute(opts.DATA_BLOCK_READY_ATTRIBUTE,!0),t.addAttribute(opts.DATA_BLOCK_PATH_ATTRIBUTE,l),t.innerHTML=o.view;var c=new Block(n,l,t,o.logic);if(_instances[l]=c,r&&i){var u=_instances[i];a===opts.CALL_BY_INDEX?u.children[n].push(c):a?u.children[n][a]=c:u.children[n]=c,c.parent=u}lookup(t).then(function(){c.load(),e(c)})})},lookup=function(t){var e=t.querySelector("["+opts.DATA_BLOCK_ATTRIBUTE+"]:not(["+opts.DATA_BLOCK_READY_ATTRIBUTE+"]"),n=Array.prototype.map.call(e,function(t){return build(t)});return Promise.all(n)},_this$1=void 0,getTarget=function t(e,n){return null==e?null:0===n.length?e:(e=e[n[0]],n.shift(),t(e,n))},bind=function(t,e){null!=t&&(t.on?(t.on(e),e(t())):e(t))},unbind=function(t,e){null!=t&&t.off&&t.off(e)},getv=function(t){return null==t?t:t.on?t():t},handle=function t(e,n){var o=void 0;if(Array.isArray(e))e.forEach(function(e){t.call(_this$1,e,n)});else{var r=e.split(".");"data"!==r[0]?(o=getTarget(self,r),bind(o,n)):(r.shift(),self.on("set",function(t){window.setTimeout(function(){_this$1.olddata&&(o=getTarget(self.olddata,r),unbind(o,n)),o=getTarget(t,r),bind(o,n)},0)}))}},rules={src:function(t,e){handle.call(_this$1,e,function(e){t.setAttribute("src",getv(e))})},text:function(t,e){handle.call(_this$1,e,function(e){t.textContent=getv(e)})},class:function(t,e,n){var o=n.split(":")[2].trim();handle.call(_this$1,e,function(e){t.classList.toggle(o,getv(e))})},href:function(t,e){handle.call(_this$1,e,function(e){t.setAttribute("href",getv(e))})},val:function(t,e){handle.call(_this$1,e,function(e){t.value=getv(e)})},html:function(t,e){handle.call(_this$1,e,function(e){t.innerHTML=getv(e)})},visible:function(t,e){handle.call(_this$1,e,function(e){t.style.display=getv(e)?"":"none"})},invisible:function(t,e){handle.call(_this$1,e,function(e){t.style.display=getv(e)?"none":""})},enable:function(t,e){handle.call(_this$1,e,function(e){t.classList.toggle("disabled",!getv(e))})},disable:function(t,e){handle.call(_this$1,e,function(e){t.classList.toggle("disabled",getv(e))})},click:function(t,e){t.addEventListener("click",function(){return _this$1[e].call(_this$1,t),!1})},prop:function(t,e){_this$1[e]=t}},_this=void 0,dataBind=function(){Array.prototype.filter.call(_this.elAll,function(t){return matches(t,"["+opts.DATA_BIND_ATTRIBUTE+"]")}).forEach(function(t){t.getAttribute(opts.DATA_BIND_ATTRIBUTE).split(",").forEach(function(e){var n=e.split(":"),o=n[0].trim(),r=n[1].trim();rules[o]&&rules[o].call(_this,t,r,e)})})},opts={DATA_BLOCK_NAME_ATTRIBUTE:"data-block-name",DATA_BLOCK_READY_ATTRIBUTE:"data-block-ready",DATA_BLOCK_PATH_ATTRIBUTE:"data-block-path",DATA_BLOCK_CALL_ATTRIBUTE:"data-block-call",DATA_BIND_ATTRIBUTE:"data-bind",CALL_BY_INDEX:"byIndex",BASE_URL:"./blocks/"},Block=function(t){function e(t,n,o,r){classCallCheck(this,e);var i=possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return i.name=t,i.path=n,i.el=o,i.elAll=o.querySelector("*:not('["+opts.DATA_BLOCK_NAME_ATTRIBUTE+"]')"),i.children={},r(i),dataBind.call(i),i}return inherits(e,t),createClass(e,[{key:"set",value:function(t){return this.fire("set",t,this.olddata),this.olddata=this.data,this.data=t,this}},{key:"load",value:function(){return this.fire("load"),this}},{key:"show",value:function(){return this.el.style.display="",this.fire("show"),this}},{key:"hide",value:function(){return this.el.style.display="none",this.fire("hide"),this}},{key:"test",value:function(){return this.el.style.display="none",this.fire("test"),this}}]),e}(PubSub),ObservableValue=function(t){function e(t){classCallCheck(this,e);var n=possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return n.data=t,n}return inherits(e,t),createClass(e,[{key:"update",value:function(t){return this.olddata=this.data,this.data=t,this.fire()}},{key:"fire",value:function(){return get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"fire",this).call(this,"update",this.data,this.olddata)}},{key:"on",value:function(t){return get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"on",this).call(this,"update",t)}}]),e}(PubSub),Observable=function(t){var e=new ObservableValue(t),n=function t(n){return void 0===n?e.data:(e.update(n),t)};return n.on=function(t){return e.on(t)},n.off=function(t){return e.off(t)},n},loadImage=function(t,e){var n=new Image;n.onload=function(){e(n)},n.src=t},loadStyle=function(t,e){var n=document.createElement("link");n.rel="stylesheet",n.href=t,document.head.appendChild(n),e(n)},loadScript=function(t,e){var n=document.createElement("script");n.type="text/javascript",n.readyState?n.onreadystatechange=function(){"loaded"!=n.readyState&&"complete"!=n.readyState||(n.onreadystatechange=null,e())}:n.onload=function(){e(n)},n.src=t,document.getElementsByTagName("head")[0].appendChild(n)},loadView=function(t,e){var n=new XMLHttpRequest;n.open("GET",t,!0),n.onreadystatechange=function(){e(this.responseText)},n.send()},TIMEOUT=3e3,LOADERS=[{type:"image",load:loadImage,ext:/\b(png|jpg|gif)\b/},{type:"style",load:loadStyle,ext:/\b(css)\b/},{type:"script",load:loadScript,ext:/\b(js)\b/},{view:"view",load:loadView,ext:/\b(html)\b/}],load=function(t){var e=t.split(".").pop(),n=LOADERS.find(function(t){return t.ext.test(e)});return new Promise(function(o){if(!n)throw"Loader for <"+e+"> files has not been implemented";n.cache||(n.cache={}),n.load(t,function(e){n.cache[t]=e,o(e)}),setTimeout(function(){n.cache[t]||(n.cache[t]=!0,o(!0))},TIMEOUT)})},mount=function(t,e,n){if(t instanceof Element!=!0)throw"el is not an Element instance";return loadBlock(e).then(function(){return t.innerHTML=n,lookup(t)})},loadDeps=function(t,e){var n=opts.BASE_URL+"/"+t,o=e.map(function(t){return-1===t.indexOf(".")?loadBlock(t):load(n+t)});return Promise.all(o)},loadBlock=function(t){return blocks[t]?blocks[t].promise:new Promise(function(e){event.on(t+".load",function(t){e(t)}),loadDeps(t,["logic.js"])})},event=new PubSub,ob=Observable;exports.event=event,exports.ob=ob,exports.define=define,exports.append=append,exports.run=run;
