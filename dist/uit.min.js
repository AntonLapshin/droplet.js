"use strict";function define(e,t,n){var o={name:e,deps:null};blocks[e]=o,o.promise=new Promise(function(r){loadDeps(e,["view.html","style.css"].concat(toConsumableArray(t))).then(function(t){for(var i=arguments.length,a=Array(i>1?i-1:0),s=1;s<i;s++)a[s-1]=arguments[s];o.view=t,o.deps=a,o.logic=function(e){n.apply(e,o.deps)},event.fire(e+".load",o),r(o)})})}function append(e,t){return mount(t,e,"<div "+opts.DATA_BLOCK_NAME_ATTRIBUTE+'="'+e+'"></div>')}function run(e){var t=window.location.search,n=t.length>0?t.substring(1):null;return this.append(n,e).then(function(e){e.test()})}function addExtension(e){_extensions.push(e)}Object.defineProperty(exports,"__esModule",{value:!0});var classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),get=function e(t,n,o){null===t&&(t=Function.prototype);var r=Object.getOwnPropertyDescriptor(t,n);if(void 0===r){var i=Object.getPrototypeOf(t);return null===i?void 0:e(i,n,o)}if("value"in r)return r.value;var a=r.get;if(void 0!==a)return a.call(o)},inherits=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},possibleConstructorReturn=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},toConsumableArray=function(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)},_uid=0,PubSub=function(){function e(){classCallCheck(this,e),this.handlers={}}return createClass(e,[{key:"on",value:function(e,t){this.handlers.hasOwnProperty(e)||(this.handlers[e]=[]);var n=_uid++;return this.handlers[e].push({token:n,handler:t}),n}},{key:"fire",value:function(e,t,n){return!!this.handlers.hasOwnProperty(e)&&(this.handlers[e].forEach(function(e){return e.handler(t,n)}),!0)}},{key:"off",value:function(e){var t=this;for(var n in this.handlers)!function(n){var o=t.handlers[n];o.forEach(function(t,n){if(t.token===e)return o.splice(n,1),!0})}(n);return!1}},{key:"once",value:function(e,t){var n=this,o=this.on(e,function(e){t(e),n.off(o)})}}]),e}(),opts={DATA_BLOCK_NAME_ATTRIBUTE:"data-block-name",DATA_BLOCK_READY_ATTRIBUTE:"data-block-ready",DATA_BLOCK_PATH_ATTRIBUTE:"data-block-path",DATA_BLOCK_CALL_ATTRIBUTE:"data-block-call",CALL_BY_INDEX:"byIndex",BASE_URL:"./blocks/"},Block=function(e){function t(e,n,o,r){classCallCheck(this,t);var i=possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return i.name=e,i.path=n,i.el=o,i.elAll=o.querySelector("*:not('["+opts.DATA_BLOCK_NAME_ATTRIBUTE+"]')"),i.children={},r(i),i}return inherits(t,e),createClass(t,[{key:"set",value:function(e){return this.fire("set",e),this.olddata=this.data,this.data=e,this}},{key:"load",value:function(){return this.fire("load"),this}},{key:"show",value:function(){return this.el.style.display="",this.fire("show"),this}},{key:"hide",value:function(){return this.el.style.display="none",this.fire("hide"),this}},{key:"test",value:function(){return this.el.style.display="none",this.fire("test"),this}}]),t}(PubSub),ObservableValue=function(e){function t(e){classCallCheck(this,t);var n=possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return n.data=e,n}return inherits(t,e),createClass(t,[{key:"update",value:function(e){return this.olddata=this.data,this.data=e,this.fire()}},{key:"fire",value:function(){return get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"fire",this).call(this,"update",this.data,this.olddata)}},{key:"on",value:function(e){return get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"on",this).call(this,"update",e)}}]),t}(PubSub),Observable=function(e){var t=new ObservableValue(e),n=function e(n){return void 0===n?t.data:(t.update(n),e)};return n.on=function(e){return t.on(e)},n.off=function(e){return t.off(e)},n},loadImage=function(e,t){var n=new Image;n.onload=function(){t(n)},n.src=e},loadStyle=function(e,t){var n=document.createElement("link");n.rel="stylesheet",n.href=e,document.head.appendChild(n),t(n)},loadScript=function(e,t){var n=document.createElement("script");n.type="text/javascript",n.readyState?n.onreadystatechange=function(){"loaded"!=n.readyState&&"complete"!=n.readyState||(n.onreadystatechange=null,t())}:n.onload=function(){t(n)},n.src=e,document.getElementsByTagName("head")[0].appendChild(n)},loadView=function(e,t){var n=new XMLHttpRequest;n.open("GET",e,!0),n.onreadystatechange=function(){4===this.readyState&&200===this.status&&t(this.responseText)},n.send()},TIMEOUT=3e3,LOADERS=[{type:"image",load:loadImage,ext:/\b(png|jpg|gif)\b/},{type:"style",load:loadStyle,ext:/\b(css)\b/},{type:"script",load:loadScript,ext:/\b(js)\b/},{view:"view",load:loadView,ext:/\b(html)\b/}],load=function(e){var t=e.split(".").pop(),n=LOADERS.find(function(e){return e.ext.test(t)});return new Promise(function(o){if(!n)throw"Loader for <"+t+"> files has not been implemented";n.cache||(n.cache={}),n.load(e,function(t){n.cache[e]=t,o(t)}),setTimeout(function(){n.cache[e]||(n.cache[e]=!0,o(!0))},TIMEOUT)})},combinePath=function(e,t){return(e?e+"+":"")+t},matches=function(e,t){return(e.matches||e.matchesSelector||e.msMatchesSelector||e.mozMatchesSelector||e.webkitMatchesSelector||e.oMatchesSelector).call(e,t)},findAncestor=function(e,t){for(;(e=e.parentElement)&&!matches(e,t););return e},blocks={},_instances={},build=function(e){return new Promise(function(t){var n=e.getAttribute(opts.DATA_BLOCK_NAME_ATTRIBUTE),o=blocks[n];if(!o.view)throw"View of "+n+" droplet is undefined";var r=findAncestor(e,"["+opts.DATA_BLOCK_NAME_ATTRIBUTE+"]"),i=r.getAttribute(opts.DATA_BLOCK_PATH_ATTRIBUTE),a=e.getAttribute(opts.DATA_BLOCK_CALL_ATTRIBUTE),s=combinePath(i,n);if(r&&i){var l=_instances[i];a===opts.CALL_BY_INDEX?(l.children[n]||(l.children[n]=[]),s+="["+l.children[n].length+"]"):"string"==typeof a&&(l.children[n]||(l.children[n]={}),s+="["+a+"]")}e.classList.add(n),e.addAttribute(opts.DATA_BLOCK_READY_ATTRIBUTE,!0),e.addAttribute(opts.DATA_BLOCK_PATH_ATTRIBUTE,s),e.innerHTML=o.view;var c=new Block(n,s,e,o.logic);if(_instances[s]=c,r&&i){var u=_instances[i];a===opts.CALL_BY_INDEX?u.children[n].push(c):a?u.children[n][a]=c:u.children[n]=c,c.parent=u}lookup(e).then(function(){c.load(),t(c)})})},lookup=function(e){var t=e.querySelector("["+opts.DATA_BLOCK_ATTRIBUTE+"]:not(["+opts.DATA_BLOCK_READY_ATTRIBUTE+"]");if(0===t.length)return new Promise(function(e){e()});var n=Array.prototype.map.call(t,function(e){return build(e)});return Promise.all(n)},_extensions=[],mount=function(e,t,n){if(e instanceof Element!=!0)throw"el is not an Element instance";return loadBlock(t).then(function(){return e.innerHTML=n,lookup(e)})},loadDeps=function(e,t){var n=opts.BASE_URL+"/"+e,o=t.map(function(e){return-1===e.indexOf(".")?loadBlock(e):load(n+e)});return Promise.all(o)},loadBlock=function(e){return blocks[e]?blocks[e].promise:new Promise(function(t){event.on(e+".load",function(e){t(e)}),loadDeps(e,["logic.js"])})},event=new PubSub,ob=Observable;exports.event=event,exports.ob=ob,exports.define=define,exports.append=append,exports.run=run,exports.addExtension=addExtension;
